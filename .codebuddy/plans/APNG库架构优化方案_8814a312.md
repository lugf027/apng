---
name: APNG库架构优化方案
overview: 基于 Compottie 最佳实践，优化 APNG Kotlin Multiplatform 库的项目结构、平台 I/O 抽象层设计和网络资源加载能力。重点是模块化改进、统一的资源加载接口和完整的网络下载/缓存功能。
todos:
  - id: setup-modules
    content: 新建 apng-network-core、apng-network、apng-resources 模块，配置 build.gradle.kts 和 settings.gradle.kts
    status: completed
  - id: core-interfaces
    content: 实现 apng-network-core 核心接口：ApngSource、ApngResourceLoader、ApngCacheStrategy、HttpClient
    status: completed
    dependencies:
      - setup-modules
  - id: lru-cache
    content: 实现 DiskApngCacheStrategy 和 DiskLruCache，参考 compottie 的 LRU 缓存实现
    status: completed
    dependencies:
      - core-interfaces
  - id: platform-loaders
    content: 为 Android/iOS/Desktop/Web 各平台实现 ApngResourceLoader
    status: completed
    dependencies:
      - core-interfaces
  - id: ktor-integration
    content: 新建 apng-network 模块，集成 Ktor HTTP 客户端，实现 KtorHttpClient 和网络加载逻辑
    status: completed
    dependencies:
      - setup-modules
  - id: network-composables
    content: 实现网络加载 Composable：rememberApngCompositionFromUrl、ApngImageFromUrl
    status: completed
    dependencies:
      - ktor-integration
  - id: resources-module
    content: 新建 apng-resources 模块，支持 Compose Resources 加载本地 APNG 文件
    status: completed
    dependencies:
      - setup-modules
  - id: compose-refactor
    content: 重构 apng-compose 模块，统一支持多种数据源（Bytes/File/Url/Resource），简化平台特定代码
    status: completed
    dependencies:
      - network-composables
      - lru-cache
  - id: integration-test
    content: 编写集成测试和示例代码，验证网络加载、缓存、进度回调功能
    status: completed
    dependencies:
      - compose-refactor
  - id: docs-migration
    content: 更新 README、QUICK_START、IMPLEMENTATION 等文档，说明新增网络功能和 API 使用方法
    status: completed
    dependencies:
      - integration-test
---

## 产品概述

对现有 Kotlin Multiplatform APNG 库进行全面优化升级，包括项目结构重组、跨平台资源加载统一、以及完整的网络 APNG 支持。

## 核心需求

### 1. 项目结构优化

- 参考 compottie 的高质量模块化架构
- 将功能拆分为核心库（apng-core）、网络基础（apng-network-core）、网络实现（apng-network）、资源管理（apng-resources）等模块
- 明确模块间的依赖关系和职责划分
- 提升项目的可维护性和可扩展性

### 2. 平台IO资源加载统一

- 设计通用的资源加载接口（ApngResourceLoader），统一各平台的资源加载方式
- 支持多种数据源：内存字节数组、本地文件、网络URL、Compose Resources
- 简化各平台的实现（Android/iOS/Desktop/Web），通过统一接口访问资源
- 消除平台特定代码的散落和重复

### 3. 完整的网络APNG支持

- 实现网络下载功能（基于 Ktor HTTP 客户端）
- 实现 LRU 磁盘缓存机制，支持自定义缓存策略
- 提供下载进度回调
- 支持自动重试和错误处理
- 提供便利的 Composable API（rememberApngCompositionFromUrl 等）

### 4. API 设计重构

- 不需要保持向后兼容性
- 支持灵活的数据源指定（ApngSource sealed class）
- 统一的缓存策略接口
- 可自定义的 HTTP 客户端实现
- 加载结果类型（Success/Error/Loading）

## 函数功能和视觉效果

**网络加载 Composable：**

- rememberApngCompositionFromUrl：异步加载网络 APNG
- ApngImageFromUrl：集成加载、显示、错误处理的完整组件
- 支持加载中和错误状态的自定义UI

**本地资源加载：**

- 通过 Compose Resources 加载本地 APNG 文件
- 支持多种资源源（文件路径、字节数组、资源包）

**缓存管理：**

- 自动 LRU 缓存网络 APNG 文件
- 支持清空缓存、查询缓存状态

## 技术栈选择

### 核心技术

- **Kotlin Multiplatform**: 主要开发语言和框架
- **Compose Multiplatform**: UI 框架（1.10.0）
- **Ktor Client**: HTTP 客户端库（3.2.3），支持跨平台网络请求
- **Okio**: 文件和 I/O 操作库（3.9.0+），支持跨平台文件系统操作
- **Kotlinx Coroutines**: 异步编程支持（1.10.2）

### 各平台特定库

- **Android**: Ktor OkHttp Client、Android Context API
- **iOS**: Ktor Darwin Client、NSFileManager/NSBundle
- **Desktop(JVM)**: Ktor OkHttp Client、Java File I/O
- **Web(WASM/JS)**: Ktor JS Client、Fetch API

---

## 实现方案

### 高层设计

采用模块化分层架构，参考 compottie 的设计理念：

1. **apng-core**: 保持现有 APNG 解析能力，无需修改
2. **apng-network-core** (新增): 提供网络加载基础设施

- 定义资源加载抽象接口 (ApngResourceLoader)
- 实现 LRU 磁盘缓存 (DiskApngCacheStrategy)
- 定义缓存策略接口 (ApngCacheStrategy)
- 定义多源数据类型 (ApngSource sealed class)

3. **apng-network** (新增): 实现网络加载功能

- 集成 Ktor HTTP 客户端
- 提供便利的网络加载 API 和 Composable

4. **apng-resources** (新增): 支持 Compose Resources

- 提供资源加载 Composable 和工具函数

5. **apng-compose**: 重构现有 Composable

- 统一支持多种数据源
- 简化平台特定代码

### 关键技术决策

**1. 资源加载抽象**

- 定义 `ApngSource` sealed class 表示数据源多态性
- 定义 `ApngResourceLoader` expect interface，各平台实现
- 核心库通过统一接口访问资源，无需关心平台差异

**2. 缓存策略**

- 实现 `ApngCacheStrategy` 接口，支持自定义缓存实现
- 提供 `DiskApngCacheStrategy` 默认实现，基于 Okio 的 LRU 缓存
- 支持内存缓存、磁盘缓存、或完全自定义策略

**3. HTTP 客户端**

- 抽象 `HttpClient` 接口支持自定义实现
- 提供 `KtorHttpClient` 默认实现（内置重试、超时等）
- 支持进度回调通过 `onProgress` 参数

**4. 并发加载和缓存**

- 使用 Kotlin Coroutines 处理异步加载
- 缓存操作使用 Okio 的原子操作保证线程安全
- 支持多个 URL 同时加载时的缓存竞态保护

---

## 实现细节

### 模块依赖关系

```
apng-compose
  ├→ apng-core
  └→ apng-network (可选)
      ├→ apng-network-core
      └→ apng-core

apng-network-core
  ├→ apng-core
  └→ okio (缓存)

apng-network
  ├→ apng-network-core
  ├→ ktor-client-core
  └→ apng-core
```

### 核心接口定义

**apng-network-core/src/commonMain**

1. **ApngSource.kt**: 多源数据类型

- Bytes: 内存字节数组
- File: 本地文件路径
- Url: 网络 URL
- Resource: Compose Resources 路径

2. **ApngResourceLoader.kt**: 资源加载接口

- expect suspend fun createResourceLoader(): ApngResourceLoader
- interface 提供 load(source: ApngSource): ByteArray

3. **ApngCacheStrategy.kt**: 缓存策略接口

- path(url: String): Path?
- save(url: String, bytes: ByteArray): Path?
- load(url: String): ByteArray?
- clear()

4. **DiskApngCacheStrategy.kt**: LRU 缓存实现

- 基于 Okio FileSystem 和 LRU 算法
- 支持自定义缓存目录和大小限制
- 原子操作保证并发安全

5. **HttpClient.kt**: HTTP 客户端接口

- suspend fun download(url: String, onProgress: (Long, Long) -> Unit): ByteArray

6. **Network.kt**: 网络加载核心逻辑

- suspend fun ApngLoader.loadFromUrl(...)
- 整合缓存、HTTP 客户端、进度回调

**apng-network/src/commonMain**

1. **KtorHttpClient.kt**: Ktor HTTP 客户端实现

- 配置重试、超时、重定向
- 支持进度监听

2. **UrlCompositionSpec.kt**: URL 便利函数

- rememberApngCompositionFromUrl()
- 快速创建 URL 数据源

3. **NetworkComposables.kt**: 网络加载 Composable

- ApngImageFromUrl()：集成加载状态的组件

### 平台特定实现

**各平台 ApngResourceLoader.platform.kt**

- **androidMain**: 使用 Context 的 assets/外存
- **iosMain**: 使用 NSBundle、NSFileManager（通过 Interop）
- **desktopMain**: 使用 Okio FileSystem
- **webMain**: 使用 Fetch API

---

## 架构设计

### 系统架构

```
┌─────────────────────────────────────────┐
│         Application Layer               │
│  (composeApp, 用户应用)                 │
└────────────────┬────────────────────────┘
                 │
┌─────────────────────────────────────────┐
│      apng-compose (UI Components)       │
│  • ApngImage / ApngImageFromUrl         │
│  • ApngAnimator / ApngState             │
│  • rememberApngComposition()            │
└────────┬─────────────────────┬──────────┘
         │                     │
    ┌────▼────────┐     ┌──────▼──────────┐
    │  apng-core  │     │  apng-network   │
    │ (解析器)    │     │  (可选)         │
    ├─────────────┤     ├─────────────────┤
    │ • Parser    │     │ • KtorHttpClient│
    │ • Image     │     │ • Composables   │
    │ • Frame     │     └────────┬────────┘
    └─────────────┘             │
                            ┌────▼──────────────┐
                            │apng-network-core  │
                            │(网络基础设施)     │
                            ├────────────────────┤
                            │ • ApngSource       │
                            │ • HttpClient       │
                            │ • CacheStrategy    │
                            │ • ResourceLoader   │
                            │ • DiskLruCache     │
                            └──────┬─────────────┘
                                   │
                            ┌──────▼──────┐
                            │  okio       │
                            │  (IO操作)   │
                            └─────────────┘

平台特定实现层：
┌──────────────────────────────────────────┐
│ androidMain / iosMain / desktopMain / webMain
│ • ApngResourceLoader.platform.kt
│ • Ktor 平台特定配置
└──────────────────────────────────────────┘
```

---

## 目录结构

### 新增模块

```
apng-network-core/
├── build.gradle.kts
└── src/
    ├── commonMain/kotlin/io/github/lugf027/apng/network/
    │   ├── ApngSource.kt              # 数据源定义
    │   ├── ApngResourceLoader.kt      # 资源加载接口
    │   ├── ApngCacheStrategy.kt       # 缓存策略接口
    │   ├── DiskApngCacheStrategy.kt   # LRU缓存实现
    │   ├── DiskLruCache.kt            # 参考 compottie 的 LRU 缓存实现
    │   ├── HttpClient.kt              # HTTP 客户端接口
    │   ├── Network.kt                 # 网络加载核心逻辑
    │   └── ApngCompositionResult.kt   # 加载结果类型
    ├── androidMain/kotlin/io/github/lugf027/apng/network/
    │   └── ApngResourceLoader.android.kt
    ├── iosMain/kotlin/io/github/lugf027/apng/network/
    │   └── ApngResourceLoader.ios.kt
    ├── desktopMain/kotlin/io/github/lugf027/apng/network/
    │   └── ApngResourceLoader.desktop.kt
    └── webMain/kotlin/io/github/lugf027/apng/network/
        └── ApngResourceLoader.web.kt

apng-network/
├── build.gradle.kts
└── src/
    ├── commonMain/kotlin/io/github/lugf027/apng/network/
    │   ├── KtorHttpClient.kt          # Ktor HTTP 客户端实现
    │   ├── UrlCompositionSpec.kt      # URL 便利函数
    │   └── NetworkComposables.kt      # 网络加载 Composable

apng-resources/
├── build.gradle.kts
└── src/
    └── commonMain/kotlin/io/github/lugf027/apng/resources/
        ├── ResourceCompositionSpec.kt # Compose Resources 支持
        └── ResourceComposables.kt     # 资源加载 Composable
```

### 修改的文件

```
apng-compose/
└── src/
    ├── commonMain/kotlin/io/github/lugf027/apng/compose/
    │   ├── ApngComposition.kt         # [MODIFY] 重构支持多数据源
    │   ├── ApngImage.kt               # [MODIFY] 支持新的加载方式
    │   ├── ApngAnimator.kt            # [MODIFY] 可能的简化
    │   └── ApngState.kt               # [MODIFY] 支持多数据源
    ├── androidMain/kotlin/.../ApngComposition.android.kt  # [MODIFY]
    ├── iosMain/kotlin/.../ApngComposition.ios.kt          # [MODIFY]
    ├── desktopMain/kotlin/.../ApngComposition.desktop.kt  # [MODIFY]
    └── webMain/kotlin/.../ApngComposition.web.kt          # [MODIFY]

apng-core/
├── build.gradle.kts                  # [MODIFY] 添加可选依赖配置
└── src/
    └── commonMain/kotlin/io/github/lugf027/apng/core/
        └── ApngLoader.kt              # [MODIFY] 添加扩展函数

settings.gradle.kts                    # [MODIFY] 新增模块声明
build.gradle.kts                       # [MODIFY] 可能添加 Compose Resources 插件
gradle/libs.versions.toml              # [MODIFY] 添加 Ktor 等依赖版本
```

---

## 关键代码结构

### 1. ApngSource.kt

```
package io.github.lugf027.apng.network

sealed interface ApngSource {
    data class Bytes(val data: ByteArray) : ApngSource
    data class File(val path: String) : ApngSource
    data class Url(val url: String) : ApngSource
    data class Resource(val resourcePath: String) : ApngSource
}
```

### 2. ApngResourceLoader.kt

```
package io.github.lugf027.apng.network

interface ApngResourceLoader {
    suspend fun load(source: ApngSource): ByteArray
}

expect suspend fun createResourceLoader(): ApngResourceLoader
```

### 3. ApngCacheStrategy.kt

```
package io.github.lugf027.apng.network

import okio.Path

interface ApngCacheStrategy {
    fun path(url: String): Path?
    suspend fun save(url: String, bytes: ByteArray): Path?
    suspend fun load(url: String): ByteArray?
    suspend fun clear()
}
```

### 4. HttpClient.kt

```
package io.github.lugf027.apng.network

interface HttpClient {
    suspend fun download(
        url: String,
        onProgress: (downloaded: Long, total: Long) -> Unit = { _, _ -> }
    ): ByteArray
}
```

### 5. Network.kt (核心加载逻辑)

```
package io.github.lugf027.apng.network

suspend fun ApngLoader.loadFromUrl(
    url: String,
    httpClient: HttpClient = DefaultHttpClient,
    cacheStrategy: ApngCacheStrategy = DiskApngCacheStrategy.Instance,
    onProgress: (downloaded: Long, total: Long) -> Unit = { _, _ -> }
): ApngImage {
    // 1. 尝试从缓存加载
    cacheStrategy.load(url)?.let { bytes ->
        return loadFromBytes(bytes)
    }
    
    // 2. 从网络下载
    val bytes = httpClient.download(url, onProgress)
    
    // 3. 保存到缓存
    cacheStrategy.save(url, bytes)
    
    // 4. 解析并返回
    return loadFromBytes(bytes)
}

// Composable 集成
@Composable
fun rememberApngCompositionFromUrl(
    url: String,
    httpClient: HttpClient = DefaultHttpClient,
    cacheStrategy: ApngCacheStrategy = DiskApngCacheStrategy.Instance
): ApngCompositionResult<ApngImage> {
    // 使用 rememberCoroutineScope 和 LaunchedEffect 处理异步加载
    // 返回 Loading/Success/Error 状态
}
```

---

## 实现要点

### 性能优化

1. **缓存优先**: 优先从磁盘缓存加载，减少网络请求
2. **流式下载**: 支持进度回调，大文件不阻塞 UI
3. **并发控制**: 使用 Coroutines 的 Mutex 保护缓存竞态条件
4. **内存管理**: LRU 缓存限制大小，避免内存溢出

### 可靠性

1. **错误处理**: 网络异常、缓存写入失败等都有处理
2. **自动重试**: Ktor 配置自动重试失败请求
3. **超时控制**: 15 秒连接超时、15 秒请求超时
4. **降级策略**: 缓存失败不阻塞加载，直接从网络加载

### 跨平台支持

1. **平台抽象**: ApngResourceLoader expect 接口隐藏平台差异
2. **Ktor 支持**: Android/OkHttp、iOS/Darwin、Desktop/OkHttp、Web/JS
3. **Okio 统一**: 所有文件 I/O 通过 Okio 完成，保证一致性

---

## 风险和缓解策略

1. **大文件内存占用**: LRU 缓存配置合理的大小限制（如 100MB）
2. **iOS Interop 复杂性**: 使用 Ktor Darwin 和 Okio 的 iOS 支持，避免直接 Interop
3. **Web WASM 限制**: Fetch API 有跨域限制，使用 CORS 配置
4. **缓存不一致**: 使用原子操作保证缓存操作的一致性